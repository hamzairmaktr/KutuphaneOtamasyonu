@page "/forgot-password"
@layout IKitaplik.BlazorUI.Components.Layout.EmptyLayout
@using IKitaplik.Entities.DTOs.UserDTOs
@using IKitaplik.BlazorUI.Services.Abstract
@inject IAuthService _authService
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center mud-width-full" Style="height: 100vh;">
    <MudPaper Elevation="3" Class="pa-8" Width="100%" MaxWidth="500px">
        <div class="d-flex justify-center mb-4">
            <MudIcon Icon="@Icons.Material.Filled.LockReset" Size="Size.Large" Color="Color.Primary" />
        </div>
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">Şifremi Unuttum</MudText>

        @if (step == 1)
        {
             <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-4">E-posta adresinizi girin, size bir doğrulama kodu gönderelim.</MudText>
             <MudForm @ref="emailForm">
                 <MudTextField @bind-Value="forgotDto.Email" Label="E-posta" Variant="Variant.Outlined" Required="true" InputType="InputType.Email" Class="mb-3"/>
                 <MudButton OnClick="SendCode" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-2" Disabled="isLoading">
                     @if(isLoading) { <MudProgressCircular Size="Size.Small" Indeterminate="true"/> } else { <text>Kod Gönder</text> }
                 </MudButton>
             </MudForm>
        }
        else
        {
            <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-4">E-postanıza gelen kodu ve yeni şifrenizi giriniz.</MudText>
            <MudForm @ref="resetForm">
                 <MudTextField @bind-Value="resetDto.Token" Label="Doğrulama Kodu" Variant="Variant.Outlined" Required="true" Class="mb-3"/>
                 <MudTextField @bind-Value="resetDto.NewPassword" Label="Yeni Şifre" InputType="InputType.Password" Variant="Variant.Outlined" Required="true" Class="mb-3"/>
                 <MudButton OnClick="ResetPass" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-2" Disabled="isLoading">
                      @if(isLoading) { <MudProgressCircular Size="Size.Small" Indeterminate="true"/> } else { <text>Şifreyi Güncelle</text> }
                 </MudButton>
            </MudForm>
        }

        <MudButton Variant="Variant.Text" OnClick="@(() => Nav.NavigateTo("/login"))" FullWidth="true" Class="mt-3">Giriş Yap'a Dön</MudButton>

    </MudPaper>
</MudContainer>

@code {
    private int step = 1;
    private bool isLoading = false;
    private ForgotPasswordDto forgotDto = new();
    private ResetPasswordDto resetDto = new();
    private MudForm emailForm;
    private MudForm resetForm;

    private async Task SendCode()
    {
        await emailForm.Validate();
        if (!emailForm.IsValid) return;

        isLoading = true;
        var res = await _authService.ForgotPassword(forgotDto);
        isLoading = false;

        if (res.Success)
        {
            Snackbar.Add(res.Message, Severity.Success);
            resetDto.Email = forgotDto.Email; // Carry over email
            step = 2;
        }
        else
        {
            Snackbar.Add(res.Message, Severity.Error);
        }
    }

    private async Task ResetPass()
    {
         await resetForm.Validate();
         if (!resetForm.IsValid) return;

         isLoading = true;
         var res = await _authService.ResetPassword(resetDto);
         isLoading = false;

         if (res.Success)
         {
             Snackbar.Add("Şifreniz başarıyla güncellendi. Giriş yapabilirsiniz.", Severity.Success);
             Nav.NavigateTo("/login");
         }
         else
         {
             Snackbar.Add(res.Message, Severity.Error);
         }
    }
}
