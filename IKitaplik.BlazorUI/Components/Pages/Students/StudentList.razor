@page "/student/list"
@inject IStudentService _studentService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject MessageBoxService MessageBoxService
@inject NavigationManager Nav
@attribute [Authorize]



<MudItem Class="mt-2 mb-2 text-end">
    <MudButton Href="student/add" Color="Color.Info" ButtonType="ButtonType.Button" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
        Yeni Öğrenci Ekle
    </MudButton>
</MudItem>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{
    <MudDataGrid T="StudentGetDto"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Öğrenciler</MudText>
        </ToolBarContent>
        <Columns>
            <TemplateColumn Title="İşlemler">
                <CellTemplate>
                    <MudButtonGroup>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick="(() => StudentUpdate(context.Item.Id))" Color="Color.Warning" Icon="@Icons.Material.Filled.Update"></MudIconButton>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => StudentDelete(context.Item.Id))" Color="Color.Error" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => GoMovements(context.Item.Id))" Color="Color.Secondary" Icon="@Icons.Material.Filled.ViewList"></MudIconButton>
                    </MudButtonGroup>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="b => b.StudentNumber" Title="Öğrenci No" />
            <PropertyColumn Property="b => b.Class" Title="Sınıf" />
            <PropertyColumn Property="b => b.Name" Title="İsim" />
            <PropertyColumn Property="b => b.EMail" Title="Email" />
            <PropertyColumn Property="@(b => b.Situation ? "Hayır" : "Evet")" Title="Kitap Okuyormu" />
            <PropertyColumn Property="b => b.NumberofBooksRead" Title="Okuduğu Kitap Sayısı" />
            <PropertyColumn Property="b => b.TelephoneNumber" Title="Telefon No" />
            <PropertyColumn Property="b => b.Point" Title="Puan" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}

@code {
    MudDataGrid<StudentGetDto> _dataGrid;
    private string errorMessage = string.Empty;
    public bool isLoading { get; set; } = true;

    private async Task<GridData<StudentGetDto>> ServerReload(GridState<StudentGetDto> gridState)
    {
        try
        {
            isLoading = true;
            var res = await _studentService.GetAllAsync(gridState.Page + 1, gridState.PageSize);
            if (!res.Success)
            {
                errorMessage = res.Message;
                return new GridData<StudentGetDto>() { Items = new List<StudentGetDto>(), TotalItems = 0 };
            }
            return new GridData<StudentGetDto>()
            {
                Items = res.Data.Items,
                TotalItems = res.Data.TotalCount
            };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void GoMovements(int id)
    {
        Nav.NavigateTo("/movements/3&" + id);
    }
    private async Task StudentDelete(int id)
    {
        bool? result = await MessageBoxService.ShowConfirmDialog("Uyarı", "Öğrenci silinsin mi ?");
        if (result.GetValueOrDefault())
        {
            var res = await _studentService.DeleteAsync(id);
            Snackbar.Add(res.Message, severity: res.Success ? Severity.Success : Severity.Error);
            if (res.Success)
            {
                await _dataGrid.ReloadServerData();
            }
            StateHasChanged();
        }
    }
    private async Task StudentUpdate(int id)
    {
        Nav.NavigateTo("student/update/" + id);
    }
}