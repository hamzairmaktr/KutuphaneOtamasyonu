@page "/donations"
@attribute [Authorize]
@inject IDonationService _service
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{

    <MudDataGrid T="DonationGetDTO"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Bağışlar</MudText>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="@(b => b.Date.ToString("dd.MM.yyyy HH:mm"))" Title="Tarih" />
            <PropertyColumn Property="b => b.BookBarcode" Title="Kitap Barkodu" />
            <PropertyColumn Property="b => b.BookName" Title="Kitap İsmi" />
            <PropertyColumn Property="b => b.StudentName" Title="Öğrenci İsmi" />
            <PropertyColumn Property="@(b => b.IsItDamaged == true ? "Evet" : "Hayır")" Title="Hasarlımı" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}
@code {
    string errorMessage = "";
    public bool isLoading { get; set; } = true;
    private MudDataGrid<DonationGetDTO> _dataGrid;

    private async Task<GridData<DonationGetDTO>> ServerReload(GridState<DonationGetDTO> gridState)
    {
        try
        {
            isLoading = true;
            var res = await _service.GetAllAsync(gridState.Page + 1, gridState.PageSize);
            if (res.Success)
            {
                return new GridData<DonationGetDTO>()
                {
                    Items = res.Data.Items,
                    TotalItems = res.Data.TotalCount
                };
            }
            else
            {
                errorMessage = res.Message;
                return new GridData<DonationGetDTO>()
                {
                    Items = new List<DonationGetDTO>(),
                    TotalItems = 0
                };
            }
        }
        finally
        {
            isLoading = false;
        }
    }
}
