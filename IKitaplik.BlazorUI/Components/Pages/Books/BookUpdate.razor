@page "/book/update/{Id:int}"
@inject IBookService _service
@inject ICategoryService _categoryService
@inject IWriterService _writerService
@inject ISnackbar Snackbar
@inject NavigationManager Nav


<h3 class="mt-2">Kitap Ekle</h3>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Class="my-3" Severity="Severity.Error">@errorMessage</MudAlert>
}

<MudTextField T="string" @bind-Value="barcode" Variant="Variant.Outlined" Label="Barkod"></MudTextField>
<MudTextField T="string" @bind-Value="name" Variant="Variant.Outlined" Label="Kitap Adı"></MudTextField>
<MudTextField T="string" @bind-Value="shelfNo" Variant="Variant.Outlined" Label="Raf No"></MudTextField>
<MudTextField T="int" @bind-Value="pageSize" Variant="Variant.Outlined" Label="Sayfa Sayısı"></MudTextField>
<MudTextField T="int" ReadOnly="true" @bind-Value="piece" Variant="Variant.Outlined" Label="Adet"></MudTextField>
<MudSelect T="CategoryGetDto" @bind-Value="Category" Label="Kategori" ToStringFunc="@(val => val?.Name ?? "")" Variant="Variant.Outlined" Class="mb-2">
    @foreach (var category in Categories)
    {
        <MudSelectItem Value="@category">@category.Name</MudSelectItem>
    }
</MudSelect>
<MudSelect T="WriterGetDto" @bind-Value="Writer" Label="Yazar" ToStringFunc="@(val => val?.WriterName ?? "")" Variant="Variant.Outlined" Class="mb-2">
    @foreach (var writer in Writers)
    {
        <MudSelectItem Value="@writer">@writer.WriterName</MudSelectItem>
    }
</MudSelect>

<MudButton OnClick="Kaydet" Class="mt-2" Variant="Variant.Filled" ButtonType="ButtonType.Button" EndIcon="@Icons.Material.Filled.Save" Color="Color.Info">Kaydet</MudButton>
<MudButton OnClick="Vazgec" Class="mt-2 ms-1" Variant="Variant.Filled" ButtonType="ButtonType.Button" EndIcon="@Icons.Material.TwoTone.Cancel" Color="Color.Error">Vazgeç</MudButton>


@code {
    [Parameter]
    public int Id { get; set; }
    private string errorMessage = "";
    private string barcode = "";
    private string name = "";
    private string shelfNo = "";
    private int pageSize = 0;
    private int piece = 0;
    private CategoryGetDto Category = null;
    private WriterGetDto Writer = null;

    private List<CategoryGetDto> Categories = new List<CategoryGetDto>();
    private List<WriterGetDto> Writers = new List<WriterGetDto>();

    protected override async Task OnInitializedAsync()
    {
        var categories = await _categoryService.GetAllAsync();
        if (categories.Success)
        {
            Categories = categories.Data;
        }
        else
        {
            errorMessage = categories.Message;
        }
        var writers = await _writerService.GetAllAsync();
        if (writers.Success)
        {
            Writers = writers.Data;
        }
        else
        {
            errorMessage = writers.Message;
        }

        var res = await _service.GetBookByIdAsync(Id);
        if (res.Success)
        {
            barcode = res.Data.Barcode;
            name = res.Data.Name;
            shelfNo = res.Data.ShelfNo;
            pageSize = res.Data.PageSize;
            piece = res.Data.Piece;

            var selectedWriterRes = await _writerService.GetAsync(res.Data.WriterId);
            if (selectedWriterRes.Success)
            {
                Writer = selectedWriterRes.Data;
            }
            else
            {
                errorMessage = selectedWriterRes.Message;
            }
            var selectedCategoryRes = await _categoryService.GetByIdAsync(res.Data.CategoryId);
            if (selectedCategoryRes.Success)
            {
                Category = selectedCategoryRes.Data;
            }
            else
            {
                errorMessage = selectedCategoryRes.Message;
            }
        }
        else
        {
            errorMessage = res.Message;
        }
    }


    private void Vazgec(MouseEventArgs args)
    {
        Nav.NavigateTo("book/list");
    }
    private async Task Kaydet(MouseEventArgs args)
    {
        errorMessage = string.Empty;

        var res = await _service.UpdateBookAsync(new BookUpdateDto
        {
            Barcode = barcode,
            Name = name,
            ShelfNo = shelfNo,
            PageSize = pageSize,
            Piece = piece,
            CategoryId = Category?.Id ?? 0,
            WriterId = Writer?.Id ?? 0,
            Id = Id
        });
        if (!res.Success)
        {
            errorMessage = res.Message;
            return;
        }

        Snackbar.Add(res.Message, Severity.Success);
        Nav.NavigateTo("book/list");
    }
}
