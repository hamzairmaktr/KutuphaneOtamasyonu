@page "/movements/{Type:int}&{Id:int}"
@using IKitaplik.Entities.Enums
@inject IMovementService _service
@attribute [Authorize]


@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{

    <MudDataGrid T="MovementGetDTO"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Hareketler</MudText>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="@(b => b.MovementDate.ToString("dd.MM.yyyy HH:mm"))" Title="Tarih" />
            <PropertyColumn Property="b => b.Title" Title="Konu" />
            <PropertyColumn Property="b => b.Note" Title="Not" />
            <PropertyColumn Property="b => b.BookName" Title="Kitap" />
            <PropertyColumn Property="b => b.StudentName" Title="Öğrenci" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}

@code {
    [Parameter]
    public int Type { get; set; }
    [Parameter]
    public int Id { get; set; }
    public bool isLoading { get; set; } = false;
    private string errorMessage = "";
    private MudDataGrid<MovementGetDTO> _dataGrid;


    private async Task<GridData<MovementGetDTO>> ServerReload(GridState<MovementGetDTO> gridState)
    {
        try
        {
            isLoading = true;
            List<MovementGetDTO> Items = new List<MovementGetDTO>();
            int TotalItems = 0;
            if ((int)MovementType.Deposit == Type)
            {
                var res = await _service.GetAllByDepositIdAsync(Id,gridState.Page + 1,gridState.PageSize);
                if (!res.Success)
                {
                    errorMessage = res.Message;
                    return new GridData<MovementGetDTO>
                    {
                        Items = new List<MovementGetDTO>(),
                        TotalItems = 0
                    };
                }
                Items = res.Data.Items;
            }
            else if ((int)MovementType.Book == Type)
            {
                var res = await _service.GetAllByBookIdAsync(Id, gridState.Page + 1, gridState.PageSize);
                if (!res.Success)
                {
                    errorMessage = res.Message;
                    return new GridData<MovementGetDTO>
                    {
                        Items = new List<MovementGetDTO>(),
                        TotalItems = 0
                    };
                }
                Items = res.Data.Items;
            }
            else if ((int)MovementType.Student == Type)
            {
                var res = await _service.GetAllByStudentIdAsync(Id, gridState.Page + 1, gridState.PageSize);
                if (!res.Success)
                {
                    errorMessage = res.Message;
                    return new GridData<MovementGetDTO>
                    {
                        Items = new List<MovementGetDTO>(),
                        TotalItems = 0
                    };
                }
                Items = res.Data.Items;
            }
            else if ((int)MovementType.Donation == Type)
            {
                var res = await _service.GetAllByDonationIdAsync(Id, gridState.Page + 1, gridState.PageSize);
                if (!res.Success)
                {
                    errorMessage = res.Message;
                    return new GridData<MovementGetDTO>
                    {
                        Items = new List<MovementGetDTO>(),
                        TotalItems = 0
                    };
                }
                Items = res.Data.Items;
            }
            else
            {
                errorMessage = "Geçersiz tip";
            }

            return new GridData<MovementGetDTO>
            {
                Items = Items,
                TotalItems = Items.Count
            };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
