@page "/writer/list"
@inject IWriterService _writerService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject MessageBoxService MessageBoxService
@attribute [Authorize]


<MudItem Class="mt-2 mb-2 text-end">
    <MudButton Href="writer/add" Color="Color.Info" ButtonType="ButtonType.Button" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
        Yeni Yazar Ekle
    </MudButton>
</MudItem>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{
    <MudDataGrid T="WriterGetDto"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Yazarlar</MudText>
        </ToolBarContent>
        <Columns>
            <TemplateColumn Title="İşlemler">
                <CellTemplate>
                    <MudIconButton ButtonType="ButtonType.Button" OnClick="(() => WriterUpdate(context.Item.Id))" Color="Color.Warning" Icon="@Icons.Material.Filled.Update"></MudIconButton>
                    <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => WriterDelete(context.Item.Id))" Color="Color.Error" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="b => b.WriterName" Title="Yazar Adı" />
            <PropertyColumn Property="b => b.BirthDate.GetValueOrDefault().ToShortDateString()" Title="Doğum Tarihi" />
            <PropertyColumn Property="@(b => b.DeathDate.HasValue ? b.DeathDate.Value.ToShortDateString() : "")" Title="Ölüm Tarihi" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}

@code {
    private string errorMessage = string.Empty;
    public bool isLoading { get; set; } = true;
    private MudDataGrid<WriterGetDto> _dataGrid;

    private async Task<GridData<WriterGetDto>> ServerReload(GridState<WriterGetDto> gridState)
    {
        try
        {
            isLoading = true;
            var res = await _writerService.GetAllAsync(gridState.Page + 1, gridState.PageSize);
            if (!res.Success)
            {
                errorMessage = res.Message;
                return new GridData<WriterGetDto>() { Items = new List<WriterGetDto>(), TotalItems = 0 };
            }
            return new GridData<WriterGetDto>()
            {
                Items = res.Data.Items,
                TotalItems = res.Data.TotalCount
            };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }


    private async Task WriterDelete(int id)
    {
        bool? result = await MessageBoxService.ShowConfirmDialog("Uyarı", "Yazar silinsin mi ?");
        if (result.GetValueOrDefault())
        {
            var res = await _writerService.DeleteAsync(id);
            Snackbar.Add(res.Message, severity: res.Success ? Severity.Success : Severity.Error);
            if (res.Success)
            {
                await _dataGrid.ReloadServerData();
            }
            StateHasChanged();
        }
    }
    private async Task WriterUpdate(int id)
    {
        Nav.NavigateTo("writer/update/" + id);
    }
}