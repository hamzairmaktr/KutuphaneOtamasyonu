@page "/category/list"
@inject ICategoryService _categoryService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject MessageBoxService MessageBoxService
@attribute [Authorize]


<MudItem Class="mt-2 mb-2 text-end">
    <MudButton Href="category/add" Color="Color.Info" ButtonType="ButtonType.Button" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
        Yeni Kategori Ekle
    </MudButton>
</MudItem>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{

    <MudDataGrid T="CategoryGetDto"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="loading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Kategoriler</MudText>
        </ToolBarContent>
        <Columns>
            <TemplateColumn Title="İşlemler">
                <CellTemplate>
                    <MudButtonGroup>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick="(() => CategoryUpdate(context.Item.Id))" Color="Color.Warning" Icon="@Icons.Material.Filled.Update"></MudIconButton>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => CategoryDelete(context.Item.Id))" Color="Color.Error" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                    </MudButtonGroup>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="b => b.Name" Title="Barkod" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}

@code {
    private string errorMessage = string.Empty;
    bool loading = true;
    MudDataGrid<CategoryGetDto> _dataGrid;
    private async Task<GridData<CategoryGetDto>> ServerReload(GridState<CategoryGetDto> gridState)
    {
        try
        {
            loading = true;
            var res = await _categoryService.GetAllAsync(gridState.Page + 1, gridState.PageSize);
            if (!res.Success)
            {
                errorMessage = res.Message;
                return new GridData<CategoryGetDto>() { Items = new List<CategoryGetDto>(), TotalItems = 0 };
            }
            return new GridData<CategoryGetDto>()
            {
                Items = res.Data.Items,
                TotalItems = res.Data.TotalCount
            };
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    private async Task CategoryDelete(int id)
    {
        bool? result = await MessageBoxService.ShowConfirmDialog("Uyarı", "Kategori silinsin mi ?");
        if (result.GetValueOrDefault())
        {
            var res = await _categoryService.DeleteAsync(id);
            Snackbar.Add(res.Message, severity: res.Success ? Severity.Success : Severity.Error);
            if (res.Success)
            {
                await _dataGrid.ReloadServerData();
            }
        }
        StateHasChanged();
    }
    private async Task CategoryUpdate(int id)
    {
        Nav.NavigateTo("category/update/" + id);
    }
}