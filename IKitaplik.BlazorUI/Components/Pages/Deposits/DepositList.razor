@page "/deposit/list"

@inject NavigationManager Nav
@inject IDepositService _service
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject MessageBoxService MessageBoxService
@attribute [Authorize]


@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="m-4" CloseIcon="@Icons.Material.Filled.Close">
        <MudText>@errorMessage</MudText>
    </MudAlert>
}
else
{
    <MudCheckBox T="bool" Label="Hepsini Getir" Value="HepsiniGetir" ValueChanged="val => HepsiniGetirChange(val)" Class="mt-2"></MudCheckBox>
    <MudDataGrid T="DepositGetDTO"
                 @ref="_dataGrid"
                 Filterable
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 ServerData="ServerReload"
                 Loading="isLoading">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Emanetler</MudText>
        </ToolBarContent>
        <Columns>
            <TemplateColumn Title="İşlemler">
                <CellTemplate>
                    <MudButtonGroup>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick="(() => DepositUpdate(context.Item.Id))" Color="Color.Warning" Icon="@Icons.Material.Filled.Update"></MudIconButton>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => DepositDelete(context.Item.Id))" Color="Color.Error" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                        <MudIconButton ButtonType="ButtonType.Button" OnClick=" (() => GoMovements(context.Item.Id))" Color="Color.Secondary" Icon="@Icons.Material.Filled.ViewList"></MudIconButton>
                    </MudButtonGroup>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="b => b.Id" Title="Nr." />
            <PropertyColumn Property="b => b.BookName" Title="Kitap" />
            <PropertyColumn Property="b => b.StudentName" Title="Öğrenci" />
            <PropertyColumn Property="@(b => b.IssueDate.ToString("dd.MM.yyyy HH:mm"))" Title="Verilme Tarihi" />
            <PropertyColumn Property="@(b => b.DeliveryDate.ToString("dd.MM.yyyy HH:mm"))" Title="Teslim Tarihi" />
            <PropertyColumn Property="@(b => b.IsDelivered ? "Evet" : "Hayıt")" Title="Teslim Edildi" />
            <PropertyColumn Property="@(b => b.IsItDamaged ? "Evet" : "Hayıt")" Title="Hasarlı Teslim" />
            <PropertyColumn Property="@(b => b.AmILate ? "Evet" : "Hayıt")" Title="Geç Teslim" />
        </Columns>
        <PagerContent>
            <MudDataGridPager></MudDataGridPager>
        </PagerContent>
    </MudDataGrid>
}

@code {
    private string errorMessage = "";
    public bool HepsiniGetir { get; set; }
    public bool isLoading { get; set; } = true;
    private MudDataGrid<DepositGetDTO> _dataGrid;

    private async Task<GridData<DepositGetDTO>> ServerReload(GridState<DepositGetDTO> gridState)
    {
        try
        {
            isLoading = true;
            var res = await _service.GetAllAsync(gridState.Page + 1, gridState.PageSize);
            if (res.Success)
            {
                var filteredItems = HepsiniGetir ? res.Data.Items : res.Data.Items.Where(p => !p.IsDelivered);
                return new GridData<DepositGetDTO>()
                {
                    Items = filteredItems,
                    TotalItems = res.Data.TotalCount
                };
            }
            else
            {
                errorMessage = res.Message;
                return new GridData<DepositGetDTO>() { Items = new List<DepositGetDTO>(), TotalItems = 0 };
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async void HepsiniGetirChange(bool val)
    {
        HepsiniGetir = val;
        await _dataGrid.ReloadServerData();
        StateHasChanged();
    }

    private void GoMovements(int id)
    {
        Nav.NavigateTo("/movements/1&" + id);
    }

    private async Task DepositDelete(int id)
    {
        bool? result = await MessageBoxService.ShowConfirmDialog("Uyarı", "Emanet silinsin mi ?");
        if (result.GetValueOrDefault())
        {
            var res = await _service.DeleteAsync(id);
            Snackbar.Add(res.Message, severity: res.Success ? Severity.Success : Severity.Error);
            if (res.Success)
            {
                await _dataGrid.ReloadServerData();
            }
            StateHasChanged();
        }
    }
    private async Task DepositUpdate(int id)
    {
        Nav.NavigateTo("/deposit/operations/" + id);
    }
}